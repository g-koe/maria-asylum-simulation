<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Maria's Asylum Case</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f9f9f9;
            margin: 0;
            padding: 0;
        }
        .progress-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: #fff;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 10px 20px;
        }
        .progress-bar {
            height: 8px;
            background: #ddd;
            border-radius: 10px;
            overflow: hidden;
            margin: 8px 0;
        }
        .progress-fill {
            height: 100%;
            width: 0;
            background: #2a72de;
            transition: width 0.3s ease;
        }
        .stage-label {
            text-align: center;
            font-size: 0.9em;
            font-weight: bold;
        }
        .content {
            padding: 140px 40px 40px 40px;
        }
        h1 {
            margin-top: 0;
        }
        img {
            max-width: 300px;
            border-radius: 10px;
            float: right;
            margin-left: 20px;
            margin-bottom: 10px;
        }
        textarea {
            width: 100%;
        }
        button {
            margin-top: 10px;
        }
        .section {
            margin-top: 80px;
            padding-top: 20px;
            border-top: 2px solid #ccc;
        }
        .welcome {
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 10px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        let studentNameSet = false;

        async function setStudentName() {
            const name = document.getElementById("student_name").value;
            if (!name) return alert("Please enter your name.");

            const res = await fetch("/set_name", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ student_name: name })
            });

            const data = await res.json();
            if (data.status === "ok") {
                document.getElementById("name_input").style.display = "none";
                document.getElementById("chat_interface").style.display = "block";
                document.getElementById("student_welcome").innerHTML = `ðŸ‘‹ Welcome, <strong>${name}</strong>!<br>You're stepping into the shoes of Maria's lawyer. Ready to help her seek justice?`;
                studentNameSet = true;
            }
        }

        async function sendMessage() {
            if (!studentNameSet) return alert("Please enter your name first.");

            const userInput = document.getElementById("user_input").value;
            const responseBox = document.getElementById("response");

            const res = await fetch("/ask", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ user_input: userInput })
            });

            const data = await res.json();
            responseBox.innerHTML += `<div><strong>You:</strong> ${userInput}</div>`;
            responseBox.innerHTML += `<div><strong>Maria:</strong> ${data.response}</div><hr>`;
            document.getElementById("user_input").value = "";
        }

        async function sendSharonMessage() {
            if (!studentNameSet) return alert("Please enter your name first.");

            const userInput = document.getElementById("sharon_input").value;
            const sharonBox = document.getElementById("sharon_response");

            const res = await fetch("/ask_sharon", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ user_input: userInput })
            });

            const data = await res.json();
            sharonBox.innerHTML += `<div><strong>You:</strong> ${userInput}</div>`;
            sharonBox.innerHTML += `<div><strong>Sharon:</strong><br>${marked.parse(data.response)}</div><hr>`;
            document.getElementById("sharon_input").value = "";
        }

        window.addEventListener("scroll", () => {
            const progressFill = document.querySelector(".progress-fill");
            const sections = [
                document.getElementById("step1"),
                document.getElementById("step2"),
                document.getElementById("step3")
            ];
            const scroll = window.scrollY + 150;
            let currentStep = 0;
            sections.forEach((section, index) => {
                if (section && scroll >= section.offsetTop) {
                    currentStep = index + 1;
                }
            });
            progressFill.style.width = `${(currentStep / sections.length) * 100}%`;
            document.querySelector(".stage-label").textContent = `Step ${currentStep}: ${["Interviewing Maria", "Lunch with Sharon", "Pleading in Court"][currentStep - 1]}`;
        });
    </script>
</head>
<body>
    <div class="progress-container">
        <div class="welcome" id="student_welcome">ðŸ‘‹ Welcome!</div>
        <div class="progress-bar"><div class="progress-fill"></div></div>
        <div class="stage-label">Step 1: Interviewing Maria</div>
    </div>

    <div class="content">
        <div id="name_input">
            <p>Please enter your name to begin:</p>
            <input type="text" id="student_name" placeholder="Your name">
            <button onclick="setStudentName()">Start Interview</button>
        </div>

        <div id="chat_interface" style="display:none;">
            <h1 id="step1">Interview with Maria</h1>
            <img src="{{ url_for('static', filename='images/maria_desk.png') }}" alt="Maria the asylum-seeker at the desk">
            <div><em>{{ initial_message | safe }}</em></div>
            <hr>
            <div id="response"></div>
            <textarea id="user_input" rows="4" placeholder="Type your question to Maria..."></textarea><br>
            <button onclick="sendMessage()">Send to Maria</button>

            <div class="section" id="step2">
                <h2>Lunch with Sharon</h2>
                <img src="{{ url_for('static', filename='images/sharon_restaurant.png') }}" alt="Sharon the lawyer at the restaurant">
                <div><em>{{ sharon_intro | safe }}</em></div>
                <hr>
                <div id="sharon_response"></div>
                <textarea id="sharon_input" rows="4" placeholder="Ask Sharon a legal question..."></textarea><br>
                <button onclick="sendSharonMessage()">Ask Sharon</button>
            </div>

            <div class="section" id="step3">
                <h2>Courtroom: Judge Leclerc</h2>
                <img src="{{ url_for('static', filename='images/judge_courtroom.png') }}" alt="Judge Jean-Marie Leclerc in the courtroom">
                <div><em>{{ judge_intro | safe }}</em></div>
                <hr>
                <div id="judge_response"></div>
                <textarea id="judge_input" rows="4" placeholder="Paste your final pleading here..."></textarea><br>
                <button onclick="sendJudgeMessage()">Submit to Judge</button>
            </div>
        </div>
    </div>
</body>
</html>
